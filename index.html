<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes">
    <title>æ‰¹é‡æ‹¼å›¾å·¥åŠ Â· è‡ªç”±æ‹¼æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #eef2f7;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, sans-serif;
            padding: 24px;
            color: #1e293b;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .app {
            max-width: 1600px;
            width: 100%;
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(12px);
            border-radius: 40px;
            padding: 28px;
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 28px;
            border: 1px solid rgba(255,255,255,0.6);
        }

        /* å·¦ä¾§æ§åˆ¶åŒº */
        .control-panel {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(4px);
            border-radius: 32px;
            padding: 24px;
            box-shadow: 0 6px 14px rgba(0,0,0,0.02);
            border: 1px solid #fff;
        }

        .control-panel h2 {
            font-size: 1.9rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            background: linear-gradient(145deg, #1e3b5a, #2c4e6e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 16px;
            border-bottom: 2px solid rgba(60, 100, 140, 0.2);
            padding-bottom: 10px;
        }

        .upload-area {
            background: #f0f6fc;
            border: 2px dashed #9bb7d4;
            border-radius: 24px;
            padding: 20px;
            text-align: center;
            transition: 0.2s;
            margin-bottom: 16px;
        }

        .upload-area:hover {
            border-color: #2e5a7f;
            background: #e3edf5;
        }

        .upload-btn {
            background: #26547c;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 60px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 6px 12px rgba(38,84,124,0.2);
            transition: 0.15s;
            display: inline-block;
        }

        .upload-btn:hover {
            background: #1a405c;
            transform: scale(0.97);
        }

        #fileInput {
            display: none;
        }

        .thumb-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-top: 10px;
            margin-bottom: 12px;
        }

        .badge {
            background: #26547c;
            color: white;
            padding: 6px 18px;
            border-radius: 60px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        #clearAllBtn {
            background: transparent;
            border: 1.8px solid #b44;
            color: #b44;
            padding: 6px 16px;
            border-radius: 60px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        #clearAllBtn:hover {
            background: #b44;
            color: white;
        }

        .thumb-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px 6px;
            background: rgba(255,255,255,0.4);
            border-radius: 20px;
            margin-bottom: 16px;
        }

        .thumb-item {
            position: relative;
            width: 68px;
            height: 68px;
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            flex-shrink: 0;
        }

        .thumb-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(0,0,0,0.7);
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            border: 1px solid white;
        }

        .remove-btn:hover {
            background: #c33;
        }

        .param-group {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 10px;
        }

        .param-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .param-row label {
            font-weight: 600;
            color: #1f4662;
            font-size: 0.96rem;
        }

        .param-row input,
        .param-row select {
            width: 100px;
            padding: 8px 12px;
            border-radius: 30px;
            border: 1.5px solid #cbdae5;
            background: white;
            font-weight: 500;
            text-align: center;
            outline: none;
            transition: 0.15s;
        }

        .param-row input:focus,
        .param-row select:focus {
            border-color: #26547c;
            box-shadow: 0 0 0 3px rgba(38,84,124,0.1);
        }

        .corner-box {
            background: #e3ecf2;
            border-radius: 24px;
            padding: 18px;
            margin-top: 16px;
        }

        .corner-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 10px;
        }

        .corner-grid label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: #1f3f55;
        }

        .generate-btn {
            background: #1e6f3c;
            color: white;
            border: none;
            padding: 16px 20px;
            border-radius: 60px;
            font-size: 1.2rem;
            font-weight: 700;
            margin-top: 28px;
            width: 100%;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: 0 10px 20px rgba(30,111,60,0.3);
            letter-spacing: 1px;
        }

        .generate-btn:hover {
            background: #155a2e;
            transform: translateY(-2px);
            box-shadow: 0 16px 24px rgba(30,111,60,0.4);
        }

        /* å³ä¾§ç»“æœåŒº */
        .result-panel {
            background: rgba(255,255,255,0.6);
            backdrop-filter: blur(4px);
            border-radius: 32px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.8);
            display: flex;
            flex-direction: column;
        }

        .result-panel h3 {
            font-size: 1.7rem;
            font-weight: 650;
            color: #1f4662;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collage-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            overflow-y: auto;
            max-height: 80vh;
            padding: 6px 4px;
            justify-content: flex-start;
            align-content: flex-start;
        }

        .collage-card {
            background: white;
            border-radius: 28px;
            padding: 20px 20px 18px;
            box-shadow: 0 12px 26px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.7);
        }

        .collage-card canvas {
            max-width: 100%;
            height: auto;
            border-radius: 20px;
            border: 2px solid #fff;
            background: #d0dfec;
        }

        .download-btn {
            margin-top: 16px;
            background: #3a6e8c;
            color: white;
            border: none;
            padding: 8px 28px;
            border-radius: 60px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            border: 1px solid white;
            transition: 0.15s;
        }

        .download-btn:hover {
            background: #27566f;
            transform: scale(0.96);
        }

        .empty-tip {
            color: #4f6f84;
            font-size: 1.2rem;
            background: rgba(255,255,255,0.7);
            border-radius: 50px;
            padding: 30px;
            width: 100%;
            text-align: center;
        }

        @media (max-width: 1000px) {
            .app {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- å·¦ä¾§ï¼šå‚æ•°ä¸å›¾ç‰‡ç®¡ç† -->
        <div class="control-panel">
            <h2>ğŸ§© æ‰¹é‡æ‹¼å›¾</h2>
            <div class="upload-area" id="uploadArea">
                <button class="upload-btn" id="uploadBtn">ğŸ“ æ‰¹é‡æ·»åŠ å›¾ç‰‡</button>
                <input type="file" id="fileInput" multiple accept="image/*" />
                <p style="margin-top: 10px; color: #2f5c77; font-size: 0.9rem;">ç‚¹å‡»æˆ–æ‹–æ‹½ï¼Œæ”¯æŒå¤šé€‰</p>
            </div>

            <div class="thumb-header">
                <span class="badge" id="imageCountDisplay">0 å¼ å›¾ç‰‡</span>
                <button id="clearAllBtn">ğŸ—‘ ä¸€é”®æ¸…ç©º</button>
            </div>
            <div id="thumbnailsList" class="thumb-list"></div>

            <div class="param-group">
                <div class="param-row">
                    <label>ğŸ”¢ è¡Œæ•°</label>
                    <input type="number" id="rowsInput" min="1" value="2" step="1">
                </div>
                <div class="param-row">
                    <label>ğŸ“Š åˆ—æ•°</label>
                    <input type="number" id="colsInput" min="1" value="3" step="1">
                </div>
                <div class="param-row">
                    <label>ğŸ”– èµ·å§‹åºå·</label>
                    <input type="number" id="startNumInput" value="1" step="1">
                </div>
                <div class="param-row">
                    <label>ğŸ”  å­—ä½“å¤§å°</label>
                    <input type="number" id="fontSizeInput" min="8" max="72" value="18" step="1">
                </div>
                <div class="param-row">
                    <label>ğŸ“ æ¯”ä¾‹</label>
                    <select id="ratioSelect">
                        <option value="3:4" selected>3 : 4</option>
                        <option value="9:16">9 : 16</option>
                    </select>
                </div>
            </div>

            <!-- å››è§’æ ‡æ³¨æ§åˆ¶ -->
            <div class="corner-box">
                <div style="font-weight: 700; margin-bottom: 8px; color: #1f4662;">ğŸ“ æ˜¾ç¤ºåºå·çš„è§’è½</div>
                <div class="corner-grid">
                    <label><input type="checkbox" id="cornerTL" checked> å·¦ä¸Š</label>
                    <label><input type="checkbox" id="cornerTR"> å³ä¸Š</label>
                    <label><input type="checkbox" id="cornerBL"> å·¦ä¸‹</label>
                    <label><input type="checkbox" id="cornerBR"> å³ä¸‹</label>
                </div>
                <p style="font-size: 0.8rem; color: #4a6679; margin-top: 10px;">å¯å¤šé€‰ï¼Œè‡³å°‘å‹¾é€‰ä¸€ä¸ªä½ç½®</p>
            </div>

            <button class="generate-btn" id="generateBtn">âš¡ ä¸€æ¬¡ç”Ÿæˆæ‹¼å›¾</button>
        </div>

        <!-- å³ä¾§ï¼šæ‹¼å›¾ç»“æœå±•ç¤ºåŒº -->
        <div class="result-panel">
            <h3>ğŸ–¼ï¸ æ‹¼å›¾è¾“å‡º</h3>
            <div id="collageContainer" class="collage-container">
                <div class="empty-tip">â¬† ä¸Šä¼ å›¾ç‰‡ï¼Œè°ƒæ•´å‚æ•°ï¼Œç‚¹å‡»ç”Ÿæˆ</div>
            </div>
        </div>
    </div>

    <script>
        (function(){
            'use strict';

            // ---------- å…¨å±€å­˜å‚¨ ----------
            const images = []; // { id, url, imgElement }

            // DOM å…ƒç´ 
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadArea = document.getElementById('uploadArea');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const thumbnailsList = document.getElementById('thumbnailsList');
            const imageCountDisplay = document.getElementById('imageCountDisplay');
            const rowsInput = document.getElementById('rowsInput');
            const colsInput = document.getElementById('colsInput');
            const startNumInput = document.getElementById('startNumInput');
            const fontSizeInput = document.getElementById('fontSizeInput');
            const ratioSelect = document.getElementById('ratioSelect');
            const cornerTL = document.getElementById('cornerTL');
            const cornerTR = document.getElementById('cornerTR');
            const cornerBL = document.getElementById('cornerBL');
            const cornerBR = document.getElementById('cornerBR');
            const generateBtn = document.getElementById('generateBtn');
            const collageContainer = document.getElementById('collageContainer');

            // å›ºå®šå•å…ƒæ ¼å®½åº¦ (px)
            const CELL_WIDTH = 160;

            // ---------- å·¥å…·å‡½æ•°ï¼šå®šä¹‰ roundRect (ç¡®ä¿å¯ç”¨) ----------
            if (!CanvasRenderingContext2D.prototype.roundRect) {
                CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
                    if (w < 2 * r) r = w / 2;
                    if (h < 2 * r) r = h / 2;
                    this.moveTo(x + r, y);
                    this.lineTo(x + w - r, y);
                    this.quadraticCurveTo(x + w, y, x + w, y + r);
                    this.lineTo(x + w, y + h - r);
                    this.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
                    this.lineTo(x + r, y + h);
                    this.quadraticCurveTo(x, y + h, x, y + h - r);
                    this.lineTo(x, y + r);
                    this.quadraticCurveTo(x, y, x + r, y);
                    return this;
                };
            }

            // ---------- æ¸²æŸ“ç¼©ç•¥å›¾ ----------
            function renderThumbnails() {
                imageCountDisplay.innerText = images.length + ' å¼ å›¾ç‰‡';
                if (images.length === 0) {
                    thumbnailsList.innerHTML = '<div style="width:100%; padding:16px; text-align:center; color:#607d8b;">ğŸ“­ æš‚æ— å›¾ç‰‡</div>';
                    return;
                }
                let html = '';
                images.forEach((imgObj, idx) => {
                    html += `<div class="thumb-item">
                                <img src="${imgObj.url}" alt="thumb" loading="lazy">
                                <span class="remove-btn" data-index="${idx}">âœ•</span>
                            </div>`;
                });
                thumbnailsList.innerHTML = html;

                // ç»‘å®šåˆ é™¤æŒ‰é’®
                document.querySelectorAll('.thumb-item .remove-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const index = parseInt(this.dataset.index, 10);
                        removeImageAtIndex(index);
                    });
                });
            }

            // ---------- åˆ é™¤å•å¼ å›¾ç‰‡ ----------
            function removeImageAtIndex(index) {
                if (index >= 0 && index < images.length) {
                    URL.revokeObjectURL(images[index].url);
                    images.splice(index, 1);
                    renderThumbnails();
                    clearCollageContainer(); // å›¾ç‰‡å˜åŠ¨ï¼Œæ¸…ç©ºæ‹¼å›¾
                }
            }

            // ---------- ä¸€é”®æ¸…ç©º ----------
            function clearAllImages() {
                images.forEach(img => URL.revokeObjectURL(img.url));
                images.length = 0;
                renderThumbnails();
                clearCollageContainer();
            }

            // ---------- æ¸…ç©ºæ‹¼å›¾æ˜¾ç¤º ----------
            function clearCollageContainer() {
                collageContainer.innerHTML = '<div class="empty-tip">â¬† ä¸Šä¼ å›¾ç‰‡ï¼Œè°ƒæ•´å‚æ•°ï¼Œç‚¹å‡»ç”Ÿæˆ</div>';
            }

            // ---------- æ‰¹é‡æ·»åŠ å›¾ç‰‡ ----------
            function addImagesFromFiles(files) {
                if (!files || files.length === 0) return;
                for (const file of files) {
                    if (!file.type.startsWith('image/')) continue;
                    const url = URL.createObjectURL(file);
                    const img = new Image();
                    img.src = url;
                    img.onload = () => {
                        images.push({
                            id: Date.now() + Math.random() + file.name,
                            url: url,
                            imgElement: img,
                            fileName: file.name
                        });
                        renderThumbnails();
                    };
                    img.onerror = () => {
                        URL.revokeObjectURL(url);
                        console.warn('å›¾ç‰‡åŠ è½½å¤±è´¥:', file.name);
                    };
                }
            }

            // ---------- äº‹ä»¶ç»‘å®šï¼šä¸Šä¼  ----------
            uploadBtn.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#26547c';
                uploadArea.style.background = '#deeaf3';
            });
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#9bb7d4';
                uploadArea.style.background = '#f0f6fc';
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#9bb7d4';
                uploadArea.style.background = '#f0f6fc';
                addImagesFromFiles(e.dataTransfer.files);
            });
            fileInput.addEventListener('change', (e) => {
                addImagesFromFiles(e.target.files);
                fileInput.value = ''; // å…è®¸å†æ¬¡é€‰æ‹©ç›¸åŒæ–‡ä»¶
            });

            // ä¸€é”®æ¸…ç©º
            clearAllBtn.addEventListener('click', clearAllImages);

            // ---------- æ ¸å¿ƒï¼šç”Ÿæˆæ‹¼å›¾ ----------
            function generateCollages() {
                if (images.length === 0) {
                    alert('è¯·å…ˆæ·»åŠ å›¾ç‰‡ï¼');
                    return;
                }

                // è¯»å–å‚æ•°
                let rows = parseInt(rowsInput.value, 10);
                let cols = parseInt(colsInput.value, 10);
                if (isNaN(rows) || rows < 1) rows = 2;
                if (isNaN(cols) || cols < 1) cols = 3;
                let startNum = parseInt(startNumInput.value, 10);
                if (isNaN(startNum)) startNum = 1;
                let fontSize = parseInt(fontSizeInput.value, 10);
                if (isNaN(fontSize) || fontSize < 6) fontSize = 18;
                const ratio = ratioSelect.value; // '3:4' æˆ– '9:16'

                // è§’è½å¤é€‰æ¡†ï¼šå¦‚æœå…¨æœªé€‰ï¼Œå¼ºåˆ¶å‹¾é€‰å·¦ä¸Šå¹¶é‡æ–°è·å–çŠ¶æ€
                let showTL = cornerTL.checked;
                let showTR = cornerTR.checked;
                let showBL = cornerBL.checked;
                let showBR = cornerBR.checked;
                if (!showTL && !showTR && !showBL && !showBR) {
                    alert('è‡³å°‘é€‰æ‹©ä¸€ä¸ªè§’è½æ˜¾ç¤ºåºå·ï¼Œå·²è‡ªåŠ¨å‹¾é€‰ã€Œå·¦ä¸Šã€');
                    cornerTL.checked = true;
                    showTL = true;
                }

                // æ ¹æ®æ¯”ä¾‹è®¡ç®—å•å…ƒæ ¼é«˜åº¦
                let cellHeight;
                if (ratio === '3:4') {
                    cellHeight = CELL_WIDTH * (4 / 3);
                } else { // 9:16
                    cellHeight = CELL_WIDTH * (16 / 9);
                }

                const pageSize = rows * cols;          // æ¯å¼ æ‹¼å›¾æœ€å¤šå›¾ç‰‡æ•°
                const totalImages = images.length;
                const pageCount = Math.ceil(totalImages / pageSize);

                // æ¸…ç©ºå¹¶é‡æ–°å¡«å……æ‹¼å›¾
                collageContainer.innerHTML = '';

                if (pageCount === 0) {
                    collageContainer.innerHTML = '<div class="empty-tip">ğŸ–¼ï¸ æ— å›¾ç‰‡å¯æ‹¼</div>';
                    return;
                }

                // é€å¼ æ‹¼å›¾ç”Ÿæˆ
                for (let page = 0; page < pageCount; page++) {
                    const startIdx = page * pageSize;

                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const canvasWidth = cols * CELL_WIDTH;
                    const canvasHeight = rows * cellHeight;
                    canvas.width = canvasWidth;
                    canvas.height = canvasHeight;

                    // ç™½è‰²èƒŒæ™¯
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvasWidth, canvasHeight);

                    // ç»˜åˆ¶æ¯ä¸ªæ ¼å­
                    for (let r = 0; r < rows; r++) {
                        for (let c = 0; c < cols; c++) {
                            const imgIndex = startIdx + (r * cols + c);
                            if (imgIndex >= totalImages) break;

                            const imgObj = images[imgIndex];
                            const img = imgObj.imgElement;
                            if (!img) continue;

                            const x = c * CELL_WIDTH;
                            const y = r * cellHeight;

                            // ---- å›¾ç‰‡ç»˜åˆ¶ï¼šå±…ä¸­è£å‰ªï¼Œå¡«æ»¡æ ¼å­ ----
                            try {
                                const imgW = img.naturalWidth || img.width;
                                const imgH = img.naturalHeight || img.height;
                                if (imgW > 0 && imgH > 0) {
                                    const cellRatio = CELL_WIDTH / cellHeight;
                                    const imgRatio = imgW / imgH;

                                    let drawW, drawH, offsetX, offsetY;
                                    if (imgRatio > cellRatio) {
                                        // å›¾ç‰‡æ›´å®½ï¼Œä»¥é«˜åº¦ä¸ºåŸºå‡†ï¼Œå®½åº¦è£å‰ª
                                        drawH = cellHeight;
                                        drawW = imgW * (cellHeight / imgH);
                                        offsetX = (CELL_WIDTH - drawW) / 2;
                                        offsetY = 0;
                                    } else {
                                        // å›¾ç‰‡æ›´é«˜ï¼Œä»¥å®½åº¦ä¸ºåŸºå‡†ï¼Œé«˜åº¦è£å‰ª
                                        drawW = CELL_WIDTH;
                                        drawH = imgH * (CELL_WIDTH / imgW);
                                        offsetX = 0;
                                        offsetY = (cellHeight - drawH) / 2;
                                    }
                                    ctx.drawImage(img, x + offsetX, y + offsetY, drawW, drawH);
                                }
                            } catch (e) {
                                console.warn('ç»˜åˆ¶å›¾ç‰‡å¤±è´¥', e);
                            }

                            // ---- æ ‡æ³¨åºå· (èƒŒæ™¯åœ†è§’æ ‡ç­¾) ----
                            const seqNum = startNum + imgIndex;
                            const text = String(seqNum);
                            ctx.font = `bold ${fontSize}px 'Inter', 'Segoe UI', 'Helvetica Neue', sans-serif`;
                            const textWidth = ctx.measureText(text).width;
                            const textHeight = fontSize * 0.8; // è¿‘ä¼¼é«˜åº¦

                            // è¾¹è·
                            const margin = 8;
                            // ç»˜åˆ¶æ–‡å­—èƒŒæ™¯ä¸æ–‡å­—çš„å‡½æ•°
                            const drawNumber = (baseX, baseY, align = 'left') => {
                                let boxX = baseX;
                                if (align === 'right') boxX = baseX - textWidth;
                                else if (align === 'center') boxX = baseX - textWidth / 2;

                                ctx.save();
                                // åŠé€é»‘åº• + é˜´å½±
                                ctx.fillStyle = 'rgba(20, 25, 35, 0.8)';
                                ctx.shadowColor = 'rgba(0,0,0,0.5)';
                                ctx.shadowBlur = 5;
                                ctx.shadowOffsetX = 1;
                                ctx.shadowOffsetY = 1;
                                ctx.beginPath();
                                ctx.roundRect(boxX - margin/2, baseY - textHeight - margin/2, textWidth + margin, textHeight + margin, 8);
                                ctx.fill();
                                ctx.restore();

                                // ç™½è‰²æ–‡å­—
                                ctx.save();
                                ctx.fillStyle = '#ffffff';
                                ctx.font = `bold ${fontSize}px 'Inter', 'Segoe UI', 'Helvetica Neue', sans-serif`;
                                ctx.shadowColor = 'black';
                                ctx.shadowBlur = 3;
                                ctx.fillText(text, baseX, baseY);
                                ctx.restore();
                            };

                            // æ ¹æ®å¤é€‰æ¡†ç»˜åˆ¶å››ä¸ªè§’è½
                            if (showTL) {
                                drawNumber(x + margin, y + fontSize + margin, 'left');
                            }
                            if (showTR) {
                                drawNumber(x + CELL_WIDTH - margin, y + fontSize + margin, 'right');
                            }
                            if (showBL) {
                                drawNumber(x + margin, y + cellHeight - margin, 'left');
                            }
                            if (showBR) {
                                drawNumber(x + CELL_WIDTH - margin, y + cellHeight - margin, 'right');
                            }
                        }
                    }

                    // ç»˜åˆ¶ç»†ç½‘æ ¼çº¿ï¼Œæ›´ç²¾è‡´
                    ctx.save();
                    ctx.strokeStyle = '#b8d0dd';
                    ctx.lineWidth = 1;
                    for (let i = 0; i <= rows; i++) {
                        ctx.beginPath();
                        ctx.moveTo(0, i * cellHeight);
                        ctx.lineTo(canvasWidth, i * cellHeight);
                        ctx.stroke();
                    }
                    for (let i = 0; i <= cols; i++) {
                        ctx.beginPath();
                        ctx.moveTo(i * CELL_WIDTH, 0);
                        ctx.lineTo(i * CELL_WIDTH, canvasHeight);
                        ctx.stroke();
                    }
                    ctx.restore();

                    // ---- å°†æ‹¼å›¾å¡ç‰‡åŠ å…¥å³ä¾§ ----
                    const card = document.createElement('div');
                    card.className = 'collage-card';
                    card.appendChild(canvas);

                    const downloadBtn = document.createElement('button');
                    downloadBtn.className = 'download-btn';
                    downloadBtn.innerText = `â¬‡ ä¸‹è½½ æ‹¼å›¾${page+1}`;
                    downloadBtn.addEventListener('click', (function(canvas) {
                        return function() {
                            const link = document.createElement('a');
                            link.download = `collage_${page+1}_${rows}x${cols}.png`;
                            link.href = canvas.toDataURL('image/png');
                            link.click();
                        };
                    })(canvas));
                    card.appendChild(downloadBtn);
                    collageContainer.appendChild(card);
                }
            }

            // ç”Ÿæˆæ‹¼å›¾æŒ‰é’®
            generateBtn.addEventListener('click', generateCollages);

            // åˆå§‹æ¸²æŸ“ç¼©ç•¥å›¾
            renderThumbnails();

            // é¡µé¢å¸è½½æ—¶é‡Šæ”¾æ‰€æœ‰ blob url
            window.addEventListener('beforeunload', function() {
                images.forEach(img => URL.revokeObjectURL(img.url));
            });
        })();
    </script>
</body>
</html>
